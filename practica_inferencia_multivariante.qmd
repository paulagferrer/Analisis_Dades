---
title: "Ejercicios de estimación y contrastes multivariantes"
subtitle: "23217- Análisis de Datos para el GMAT"
autor: "Paula G Ferrer, Josep Cifre y Marc Escandell"
date: today
format:
  html:
    theme: lumen
    toc: true
    toc-depth: 3
Rendering:
    embed-resources: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Problema 1

Una empresa de marketing realizó una encuesta a 500 clientes para conocer sus preferencias entre tres productos: A, B y C. Los resultados fueron los siguientes:

-   Producto A: 200 clientes lo prefieren.
-   Producto B: 150 clientes lo prefieren.
-   Producto C: 150 clientes lo prefieren.

(a) Define un modelo multinomial para las preferencias de los clientes. Estima los parámetros del modelo.

    #### Respuesta 1.a

(b) Utiliza el modelo para estimar la probabilidad de que en una muestra de 10 clientes, 5 prefieran el producto A, 3 prefieran el producto B y 2 prefieran el producto C. Utiliza R para hacer los cálculos.

    #### Respuesta 1.b

(c) Simula 1000 muestras aleatorias de tamaño 10 y calcula cuántas veces ocurre cada combinación de preferencias. Calcula la frecuencia con la que aparece cada combinación de preferencias en las simulaciones. Compara la probabilidad teórica calculada en el apartado b con la frecuencia observada en las simulaciones.

    #### Respuesta 1.c

# Problema 2

Una organización ambiental está interesada en modelar los niveles de contaminación en una ciudad, tomando en cuenta dos variables: la cantidad de emisiones industriales (en toneladas) y la densidad de tráfico (número de vehículos por kilómetro cuadrado). Se ha tomado una muestra de $n=5$ días en los que se midieron estas variables, junto con los niveles de contaminación registrados (en partículas por millón). Los datos son los siguientes:

| Contaminación (Y) | Emisiones Industriales (X1) | Densidad de Tráfico (X2) |
|-------------------|-----------------------------|--------------------------|
| 50                | 200                         | 150                      |
| 60                | 240                         | 170                      |
| 55                | 220                         | 160                      |
| 52                | 210                         | 155                      |
| 58                | 230                         | 165                      |

Supón que los datos siguen un modelo de regresión multivariante del tipo:

$$
Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2 + \epsilon
$$

Donde $Y$ es el vector de niveles de contaminación, $X_1$ es el vector de emisiones industriales, $X_2$ es la densidad de tráfico, y $\epsilon$ es el término de error.

Calcula la función de score e interpreta el resultado en este contexto ambiental

#### Respuesta 2

El vector de observaciones $Y \in \mathbb{R}^n$ viene relacionado por la matriz $X$ de datos y los parámetros $\beta$ según la relación

$$
Y = X \beta + \epsilon= \begin{bmatrix}
1 & X_{11} & X_{12}\\
\vdots & \vdots & \vdots\\
1 & X_{n1} & X_{n2}
\end{bmatrix}
\begin{bmatrix}
\beta_0\\ \beta_1\\ \beta_2
\end{bmatrix} + \begin{bmatrix}
\epsilon_1\\ \vdots\\ \epsilon_n
\end{bmatrix} \Rightarrow \epsilon = Y - X \beta$$

Donde $\epsilon$ suponemos que sigue una distribución normal $N(0, \sigma^2)$.

Recordemos que la función score la definimos en los apuntes como:

$$
z(X, \theta) = \sum_{i=1}^n \frac{\partial}{\partial \theta} \log f(x_i, \theta)
$$

La función de verosimilitud de $\epsilon$ bajo normalidad es: $$
L(\beta, \sigma^2) = \prod_{i=1}^n (2 \pi \sigma^2)^{-1/2}\exp\left( -\frac{1}{2\sigma^2}(\epsilon_i)^2 \right) =  (2 \pi \sigma^2)^{-n/2} \exp\left( -\frac{1}{2\sigma^2}\sum_{i=1}^n(Y_i - \beta_0 + \beta_1 X_{i1} + \beta_2 X_{i2})^2 \right)$$

$$
L(\beta, \sigma^2) = (2\pi\sigma^2)^{-n/2} \exp\left( -\frac{1}{2\sigma^2}(Y-X\beta)^t (Y-X\beta) \right), $$ y su log-verosimilitud: $$ 
\ell(\beta, \sigma^2) = -\frac{n}{2}\log(2\pi\sigma^2) -\frac{1}{2\sigma^2}(Y-X\beta)^t (Y-X\beta) $$

El score es el gradiente de la log-verosimilitud respecto a los parámetros:

$$ z(\beta,\sigma^2) =
\begin{pmatrix}
\dfrac{\partial\ell}{\partial\beta}\\[6pt]
\dfrac{\partial\ell}{\partial\sigma^2}
\end{pmatrix}$$

Calculando las derivadas:

$$
\frac{\partial\ell}{\partial\beta} = \frac{1}{\sigma^2} X^t (Y - X\beta), 
$$

$$
\frac{\partial\ell}{\partial\sigma^2} = -\frac{n}{2\sigma^2} + \frac{1}{2\sigma^4}(Y-X\beta)^t (Y-X\beta) $$

Por tanto, la función score es:

$$ 
z(\beta,\sigma^2)
=\begin{pmatrix}
\dfrac{1}{\sigma^2}X^t(Y - X\beta)\\[8pt]
-\dfrac{n}{2\sigma^2} + \dfrac{(Y-X\beta)^t(Y-X\beta)}{2\sigma^4}
\end{pmatrix}
$$

Los zeros de esta función equivalen a las equaciones

$$
\begin{cases}
\dfrac{1}{\sigma^2}X^t(Y - X\beta) = 0 \\
-\dfrac{n}{2\sigma^2} + \dfrac{(Y-X\beta)^t(Y-X\beta)}{2\sigma^4} = 0
\end{cases}
\Rightarrow
\begin{cases}
\hat{\beta} = (X^tX)^{-1}X^tY \\
\hat{\sigma}^2 = \dfrac{(Y-X\beta)^t(Y-X\beta)}{n}
\end{cases}$$

Siendo $\hat{\beta}$ i $\hat{\sigma}^2$ los estimadores de máxima verosimilitud. Notamos que necesitamos que $X^t X$ sea invertible o, equivalentemente, que el rango de $X$ sea máximo. Lo metemos en R:

```{r, message=FALSE, echo=TRUE, warning=FALSE}
# Datos
Y  <- c(50, 60, 55, 52, 58)
X1 <- c(200, 240, 220, 210, 230)
X2 <- c(150, 170, 160, 155, 165)
n  <- length(Y)

# Matriz de diseño
X <- cbind(1, X1, X2)

# función de log-verosimilitud (apunts)
logVeros <- function(beta, sigma2) {
  # beta: vector (beta0, beta1, beta2)
  # sigma2: varianza sigma^2
  # devuelve log L(beta, sigma^2)
  - (n/2)*log(2*pi*sigma2) -
    (1/(2*sigma2)) * t(Y - X %*% beta) %*% (Y - X %*% beta)
}

# función score (gradiente de la log-verosimilitud)
score <- function(beta, sigma2) {
  # según el temario:
  # s_beta = (1/sigma^2) X'(Y - X*beta)
  # s_sigma2 = -(n/(2sigma^2)) + (1/(2sigma^4))(Y - X*beta)'(Y - X*beta)
  
  resid <- Y - X %*% beta
  s_beta <- (1/sigma2) * t(X) %*% resid
  s_sigma2 <- -n/(2*sigma2) + as.numeric((t(resid) %*% resid) / (2*sigma2^2))
  
  return(list(s_beta = s_beta, s_sigma2 = s_sigma2))
}

# Comprobamos la función con valores iniciales (p.ej. beta = 0, sigma2 = 1)
beta0 <- matrix(c(0, 0, 0), ncol=1)
sigma20 <- 1
score(beta0, sigma20)

# Comprobamos colinealidad (por si X'X es singular)
det(t(X) %*% X)  # Si da 0, hay colinealidad perfecta
```

El score es el gradiente de la log-verosimilitud, que indica la dirección en que habría que modificar los parámetros para aumentar la verosimilitud. En el máximo de verosimilitud el score se anula, es decir, el modelo ajusta a los datos observados. Ahora bien, este máximo no és único ya que el rango de $X$ no es máximo, de hecho $X_2 = 0.5 \cdot X_1 + 50$.

Ahora bien, debido a esta relación lineal podemos despreciar una de las costantes del modelo imponiendo que, por ejemplo, $\beta_0 = 0$, ya que el modelo lineal se puede reescribir como $Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2 = \left(\beta_1 - \dfrac{1}{100} \beta_0\right) X_1 + \left(\beta_2 + \dfrac{1}{50}\beta_0\right)X_2$, es decir, dependa linealmente de $X_1$ i $X_2$ sin constantes adicionales.

Rehaciendo los cálculos imponiendo lo mencionado,

```{r, message=FALSE, echo=TRUE, warning=FALSE}
X_red <- X[, -1]

beta1 <- solve(t(X_red) %*% X_red, t(X_red) %*% Y)
rownames(beta1) <- c('beta1', 'beta2')
sigma21 <- as.numeric((t(Y - X_red %*% beta1) %*% (Y - X_red %*% beta1))) / n

beta1
sigma21

epsilon <- Y - X_red %*% beta1
epsilon
```

El modelo lineal ajusta muy bien los datos observados ($\hat{\sigma}^2 = 0.08$), mostrando una relación positiva y fuerte entre las emisiones y/o tráfico, y los niveles de contaminación.

Sin embargo, las dos variables explicativas son linealmente dependientes, por lo que no es posible separar el efecto de cada una sobre la contaminación.

Para distinguir los impactos individuales de las emisiones industriales y del tráfico sería necesario disponer de más observaciones en las que ambas variables varíen de manera independiente (por ejemplo, días con distinta actividad industrial pero tráfico similar, o viceversa).

Con lo que tenemos, solo nos permite afirmar que cuando aumenta simultáneamente la actividad industrial y el tráfico, la contaminación aumenta, y que esa relación se explica con muy poca variabilidad residual.

# Problema 3

Una clínica está realizando un estudio para evaluar la eficacia de un nuevo tratamiento médico para reducir la presión arterial. Se selecciona una muestra de $n = 10$ pacientes y se mide la disminución de la presión arterial (en mmHg) después de aplicar el tratamiento. El cambio en la presión arterial se modela mediante una distribución normal con media $\mu$ y varianza $\sigma^2$.

Las disminuciones observadas en la presión arterial de los pacientes son las siguientes (en mmHg):

| Paciente | Disminución (Y) |
|----------|-----------------|
| 1        | 12              |
| 2        | 8               |
| 3        | 10              |
| 4        | 15              |
| 5        | 7               |
| 6        | 9               |
| 7        | 14              |
| 8        | 11              |
| 9        | 13              |
| 10       | 6               |

Se asume que los datos provienen de una distribución normal $Y_i \sim N(\mu, \sigma^2)$.

(a) ¿Cuáles son las estimaciones de máxima verosimilitud para $\mu$ y $\sigma^2$ en este modelo?

#### Respuesta 3.a

(b) Calcula la matriz de información de Fisher para los parámetros $\mu$ y $\sigma^2$ en este modelo e interpreta los resultados.

#### Respuesta 3.b

# Problema 4

Una empresa desea comprobar si el perfil medio de sus trabajadores en cuanto a\
rendimiento ($X_1$) y satisfacción laboral ($X_2$) coincide con los valores de referencia establecidos por la dirección:

$$
\boldsymbol{\mu}_0 =
\begin{pmatrix}
70\\
7
\end{pmatrix}.
$$

Para ello, se selecciona una muestra aleatoria de tamaño $n$ de empleados y se registran sus puntuaciones en ambas variables. Se asume que el vector de observaciones

$$
\mathbf{X} = (X_1, X_2)^\top
$$

sigue una distribución normal bivariante

$$
\mathbf{X} \sim N_2(\boldsymbol{\mu}, \boldsymbol{\Sigma}),
$$

con matriz de covarianzas desconocida $\boldsymbol{\Sigma}$.

Se desea contrastar la hipótesis

$$
H_0: \boldsymbol{\mu} = \boldsymbol{\mu}_0
\quad \text{frente a} \quad
H_1: \boldsymbol{\mu} \neq \boldsymbol{\mu}_0,
$$

(a) Genera una muestra simulada de tamaño $n$ de la distribución $N_2(\boldsymbol{\mu}, \boldsymbol{\Sigma})$ (elige unos valores razonables para $\boldsymbol{\mu}$ y $\boldsymbol{\Sigma}$).

#### Respuesta 4.a

(b) Calcula la media muestral $\bar{\mathbf{X}}$, la matriz de covarianzas $\mathbf{S}$ y el estadístico de Hotelling $T^2$.

#### Respuesta 4.b

(c) Transforma $T^2$ a la escala F usando la distribución $F_{p,\,n-p}$ y calcula el p-valor del contraste para un nivel de significación $\alpha = 0.05$.

#### Respuesta 4.c

(d) Decide si se rechaza o no $H_0$.

#### Respuesta 4.d

(e) Interpreta el resultado en el contexto del problema: ¿parece que el vector medio real de la población difiere de $\boldsymbol{\mu}_0$?

#### Respuesta 4.e

# Problema 5

Un laboratorio de psicología quiere comparar el perfil cognitivo medio de dos grupos de estudiantes universitarios: los que duermen al menos 8 horas diarias y los que duermen menos de 6 horas.

A cada participante se le administran dos pruebas:

-   $X_1$: tiempo de reacción (en milisegundos, menor es mejor),
-   $X_2$: puntuación de memoria a corto plazo (de 0 a 20, mayor es mejor).

Se asume que cada grupo sigue una distribución normal bivariante con igual matriz de covarianzas $\boldsymbol{\Sigma}$:

$$
\mathbf{X}_1 \sim N_2(\boldsymbol{\mu}_1, \boldsymbol{\Sigma}), \qquad
\mathbf{X}_2 \sim N_2(\boldsymbol{\mu}_2, \boldsymbol{\Sigma}).
$$

Se desea contrastar la hipótesis

$$
H_0: \boldsymbol{\mu}_1 = \boldsymbol{\mu}_2
\quad \text{frente a} \quad
H_1: \boldsymbol{\mu}_1 \neq \boldsymbol{\mu}_2.
$$

*Datos simulados:*

| Grupo | $X_1$ (tiempo reacción, ms) | $X_2$ (memoria) |
|:---|---:|---:|
| Dormir ≥ 8h | 268, 275, 290, 260, 280, 295, 300, 285, 270, 310 | 15, 14, 17, 16, 15, 18, 17, 16, 15, 17 |
| Dormir \< 6h | 305, 320, 330, 310, 325, 335, 340, 315, 310, 330 | 12, 11, 10, 13, 12, 11, 10, 12, 11, 10 |

Contrasta la hipótesis anterior con un nivel de significación $\alpha = 0.05$ e interpreta los resultados en el contexto del problema. \#### Respuesta 5
