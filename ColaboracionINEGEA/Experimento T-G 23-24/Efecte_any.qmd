---
title: "Efecte_any"
format: html
editor: visual
---

```{r, message=FALSE, warning=FALSE}
library(readxl) #leer excel
library(writexl) #escribir en excel
library(openxlsx) #va mejor si hay muchas hojas
library(dplyr)
library(ggplot2)
options(digits = 10)

datosCombinaciones24 <- read_excel("Excel Completo Combinaciones 2024.xlsx", sheet = 10) # leemos la pagina li cor limpio
#View(datosCombinaciones24)
datosCombinaciones23 <- read_excel("VidComb 2023 Limpio.xlsx", sheet = 3) #leemos la pagina todo limpio
#View(datosCombinaciones23)

#unique(datosCombinaciones23$Fecha) # 5 momentos
#unique(datosCombinaciones24$Momento) # 7 momentos
```

```{r, message=FALSE, warning=FALSE}
preparar_datos <- function(data, año) {
  # por si hay errores en los nombres (aunque al final los cambié en los excels a mano)
  if ("Clon" %in% names(data)) data <- rename(data, Vinifera = Clon)
  if ("Genotipo" %in% names(data)) data <- rename(data, Combinacion = Genotipo)
  if ("Fecha" %in% names(data)) data <- rename(data, Momento = Fecha)
  
  #selecciono solo las varibles que me interesan
  data <- data %>%
    select(Vinifera, Portainjerto, Combinacion, Replica, Momento, WUEi, Ymd, Ypd, AN, gs) %>%
    mutate(
      WUEi = as.numeric(gsub("[^0-9,.-]", "", as.character(WUEi))),
      Ymd  = as.numeric(gsub("[^0-9,.-]", "", as.character(Ymd))),
      Ypd  = as.numeric(gsub("[^0-9,.-]", "", as.character(Ypd))),
      AN = as.numeric(gsub("[^0-9,.-]", "", as.character(AN))),
      gs = as.numeric(gsub("[^0-9,.-]", "", as.character(gs))),
      Indice = WUEi / abs(Ymd - Ypd),
      Año = año
    )
  return(data)
}

# Aplicamos la función a cada data
datos_2023 <- preparar_datos(datosCombinaciones23, 2023)
datos_2024 <- preparar_datos(datosCombinaciones24, 2024)
# Unimos
datos_todos <- bind_rows(datos_2023, datos_2024)


# funcion comparativa de los graficos entre los años para ver efecto año: comprobado que hay efecto año graficamente
plot_spaghetti <- function(data, variedad, variable) {
  
  data_filtrada <- data %>%
    filter(Vinifera == variedad)
  
  ggplot(data_filtrada, aes(x = Momento, y = !!sym(variable),
                            color = Portainjerto, group = interaction(Portainjerto, Replica))) +
    geom_line(alpha = 0.5) +
    stat_summary(fun = mean, geom = "line", aes(group = Portainjerto),
                 size = 1.5, linetype = "solid") +
    facet_wrap(~Año) +
    labs(title = paste("Spaghetti plot de", variable, "para", variedad),
         y = variable, x = "Momento") +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5))
}
```

```{r, message=FALSE, warning=FALSE}
# ejemplos 
# T232 con WUEi
plot_spaghetti(datos_todos, "T232", "WUEi")

# T232 con índice
plot_spaghetti(datos_todos, "T232", "Indice")

# T232 con AN
plot_spaghetti(datos_todos, "T232", "AN")

# T232 con gs
plot_spaghetti(datos_todos, "T232", "gs")

# ya comprobado el efecto año graficamente
# plot_spaghetti(datos_todos, "T1052", "WUEi")
# plot_spaghetti(datos_todos, "T1052", "Indice")
# plot_spaghetti(datos_todos, "G15", "WUEi")
# plot_spaghetti(datos_todos, "G15", "Indice")
# plot_spaghetti(datos_todos, "G435", "WUEi")
# plot_spaghetti(datos_todos, "G435", "Indice")
```

```{r, message=FALSE, warning=FALSE}
# ANOVA simple para WUEi e Índice
anova_wuei <- aov(WUEi ~ Año + Vinifera + Portainjerto + Año:Vinifera, data = datos_todos)
anova_indice <- aov(Indice ~ Año + Vinifera + Portainjerto + Año:Vinifera, data = datos_todos)

summary(anova_wuei)

summary(anova_indice)

# se confirma el efecto año segun los datos.
```

Anova WUEi –\>

Respecto al año: con un p valor (p\<0.001) muy significativo, vemos un efecto año probablemente por diferencias ambientales (contexto).

Respesto a los clones: No hay unas diferencias significativas (p=0.46) entre los clones (T / G) en cuanto al valor medio WUEi. Generalmente, son similares en comportamiento.

Respecto al portainjerto: (p=0.045) hay influencia moderada de la eleccion del portainjerto sobre WUEi.

Interaccion entre Año y Clon? p=0.63, no muy significativa, el cambio entre años afecta de manera similar a todos los clones, no hay uno que destaque o reacciones de manera distinta entre años.

Resumen: efecto año si, comportamientos similares y no influencias muy significativas.

Anova Indice –\>

Respecto al año: con un p valor (p\<0.001) muy significativo, el efecto año afecta al indice

Respesto a los clones y portainjertos: No hay unas diferencias significativas entre clones ni entre portainjertos en el indice

Interaccion entre Año y Clon? p=0.085, hay una tendencia (visible pero no fuerte) a que algunos clones se comporten distinto entre años, su repsuesta relativa cambia un poco según el año (podria considerarse marginalmente significativa?)

Resumen: efecto año si, la interaccion entre año y clon podrian sugerir que algunos clones se ajustan mejor pero esto en los graficos se vera mejor para poder confirmar.

Conclusion general: los efectos (ambientales o lo que sea) del año dominan la respiuesta fisiologica (wuei e indice). Los portainjertos modulan un poco la eficiencia pero solo se ha visto en wuei. Los clones no muestran diferencias fuertes por si mismos.

```{r, message=FALSE, warning=FALSE}
#ranking general (de los dos años) en wuei e indice
ranking <- datos_todos %>%
  group_by(Vinifera, Portainjerto) %>%
  summarise(
    Media_WUEi = mean(WUEi, na.rm = TRUE),
    Media_Indice = mean(Indice, na.rm = TRUE)
  ) %>%
  mutate(
    Ranking_WUEi = rank(-Media_WUEi, ties.method = "min"),
    Ranking_Indice = rank(-Media_Indice, ties.method = "min"),
    Ranking_Total = rank(-(Media_WUEi + Media_Indice)/2)
  ) %>%
  arrange(Ranking_Total)

print(ranking)
```

Ahora comparemos los años por separado y veamos como se comporta cada combinación en las diferentes varibles que tenemos.

```{r message=FALSE, warning=FALSE}
preparar_datos <- function(data, año) {
  # corregir nombres por si acaso
  if ("Clon" %in% names(data)) data <- rename(data, Vinifera = Clon)
  if ("Genotipo" %in% names(data)) data <- rename(data, Combinacion = Genotipo)
  if ("Fecha" %in% names(data)) data <- rename(data, Momento = Fecha)
  
  # quedarnos solo con lo que interesa
  data <- data %>%
    select(Vinifera, Portainjerto, Combinacion, Replica, Momento, WUEi, Ymd, Ypd, AN, gs) %>%
    mutate(
      across(c(WUEi, Ymd, Ypd, AN, gs),
             ~ as.numeric(gsub("[^0-9,.-]", "", as.character(.)))),
      Indice = WUEi / abs(Ymd - Ypd),
      Año = año
    )
  return(data)
}

# Aplicar función
datos_2023 <- preparar_datos(datosCombinaciones23, 2023)
datos_2024 <- preparar_datos(datosCombinaciones24, 2024)

# Unir ambos
datos_todos <- bind_rows(datos_2023, datos_2024)

# calculamos promedios
promedios <- datos_todos %>%
  group_by(Año, Vinifera, Portainjerto, Combinacion) %>%
  summarise(
    mean_WUEi = mean(WUEi, na.rm = TRUE),
    mean_Indice = mean(Indice, na.rm = TRUE),
    mean_AN = mean(AN, na.rm = TRUE),
    mean_gs = mean(gs, na.rm = TRUE),
    n_obs = n(), #número de observaciones por combinación
    # 6 replicas x nº momentos
#simplemente cuenta cuántas réplicas había en los datos originales para esa combinación (Vinífera × Portainjerto × Año). Me ayuda para saber si hay muchos NA o que pasa
#n_obs = 42: combinación completa (6 réplicas × 7 momentos). Menos en 2023 que solo hay 5 moemntos
#n_obs < 42: combinación incompleta (faltan datos en alguna réplica o momento).
#n_obs > 42: normalmente error o duplicado (en nuestro caso tiene pinta que es más lo segundo)
    .groups = "drop"
  )

# grafica de correlacion
library(GGally)
library(ggplot2)

# Filtrar por año y graficar
graficar_correlaciones <- function(data, year_label) {
  df <- data %>% filter(Año == year_label)
  
  ggpairs(
    df,
    columns = c("mean_WUEi", "mean_Indice", "mean_AN", "mean_gs"),
    mapping = aes(color = Vinifera),
    upper = list(continuous = wrap("cor", method = "spearman", size = 1)),
    lower = list(continuous = "smooth"),
    diag = list(continuous = "densityDiag")
  ) +
    theme_minimal() +
    ggtitle(paste("Correlaciones entre variables -", year_label))
}

p2023 <- graficar_correlaciones(promedios, 2023)
p2024 <- graficar_correlaciones(promedios, 2024)

resumenPromedios23 <- read.csv("resumen_promedios_2023.csv")
print(resumenPromedios23)
resumenPromedios24 <- read.csv("resumen_promedios_2024.csv")
print(resumenPromedios24)

print(p2023)
print(p2024)

```
