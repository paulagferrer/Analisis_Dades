---
title: "Ejercicios de Estadística descriptiva multivariante"
format:
  html:
    theme: lumen
    toc: true
editor: 
  markdown: 
    wrap: 72
---

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(GGally)
library(tidyverse)
```

## Ejercicio

Una empresa quiere analizar si existe relación entre las ventas de sus
productos, la inversión en publicidad y la satisfacción del cliente. Los
datos que corresponden a las ventas en miles de unidades, el gasto en
publicidad en miles de euros y la puntuación de satisfacción del cliente
en una escala de 1 a 10 para 15 productos, los puedes descargar en el
siguiente enlace: [datos
empresa](https://github.com/igmuib/Practica_AD/blob/main/datos_empresa.csv)

Leemos los datos

```{r, message=FALSE}
ruta<- "C:/Users/Paula García Ferrer/OneDrive/Escritorio/Analsis_Dades_Multi/Analisis_Dades/Taller1/datos_empresa.csv"
datos_empresa <- read.csv(ruta)
datos_empresa = datos_empresa[1:15,]
library(tidyverse)
glimpse(datos_empresa)
```

### Apartado a

Calcula, por un lado con formulación matricial y, por otro, mediante
instrucciones en R/tidyverse, el vector de medias y la matriz de
covarianzas para las variables cuantitativas del conjunto datos_empresa.
A continuación, interpreta los resultados en el contexto del problema.

#### Respuesta 

*Respuesta Irene:* En primer lugar creamos la matriz de datos con las
variables cuantitativas y luego, vamos calculando e interpretando cada
una de las
cosas.

```{r}
datos_empresa <- datos_empresa %>% 
  select(-Marca, -Producto)

X <- as.matrix(datos_empresa)

# Forma matricial
x_bar_t <- (t(matrix(1, nrow = nrow(X), ncol = 1)) %*% X) / nrow(X)
x_bar_t

## Con R base
colMeans(X)

## Con tidyverse 
datos_empresa %>%
  summarise(across(where(is.numeric), mean))
```

*Interpretación*: De media, cada producto vende 164 mil unidades,
destina 32.3 mil euros a publicidad y alcanza una satisfacción media de
8.35/10, lo que indica un nivel alto de satisfacción del cliente.

```{r}
# Forma matricial
n <- nrow(X)
H <- diag(n) - matrix(1, n, n) / n
S <- (t(X) %*% H %*% X) / (n - 1)
S

## Con R base
cov(X)  # usa 1/(n-1)

## Con tidyverse
X %>%cov()
```

*Interpretación:* En estos 15 productos, las ventas muestran una
varianza grande (822), la publicidad varía de forma moderada (31.7) y la
satisfacción del cliente cambia poco alrededor del 8.35 (0.374). Las
covarianzas son positivas: más publicidad se asocia con más ventas
(159.3), mayor satisfacción también se relaciona con más ventas (16.7)
y, aunque más débil, un mayor gasto publicitario se vincula ligeramente
con mejor satisfacción (3.30). Como las magnitudes dependen de las
unidades (miles de unidades vendidas, miles de euros y escala 1–10),
para comparar la “fuerza” de estas relaciones es mejor mirar las
correlaciones; aun así, el mensaje es: invertir más en publicidad y
mejorar la satisfacción tienden a acompañarse de más ventas.

### Apartado b

Calcula, por un lado con formulación matricial y, por otro, mediante
instrucciones en R/tidyverse la matriz de correlaciones. Presenta una
visualización de ella con la librería `GGally`y la función `ggpairs()`.
Interpreta el resultado en el contexto del problema.

#### Respuesta

*Respuesta Irene:* Vamos a calcularla para las variables cuantitativas
del conjunto de datos:

```{r}
# Forma matricial
D <- diag(sqrt(diag(S)))
R <- solve(D) %*% S %*% solve(D)

## Con R base
cor(X)

## Con tidyverse
X %>%cor()
```

*Interpretación:* Las tres variables están muy fuertemente
correlacionadas entre sí: Ventas–Publicidad ≈ 0.99, Ventas–Satisfacción
≈
0.95 y Publicidad–Satisfacción ≈ 0.96. Cuando un producto invierte más
en publicidad, suele vender bastante más, y los productos con mayor
satisfacción de clientes también tienden a vender más. En términos
prácticos, el portafolio se comporta casi “en línea recta”: cambios en
una de estas métricas se acompañan de cambios en las otras dos en la
misma dirección. Cuidado que: (1) la correlación no implica causalidad
(puede haber factores comunes como calidad, precio o madurez del
producto); (2) con relaciones tan altas podría haber multicolinealidad
en modelos explicativos.

### Apartado c

Define una variable compuesta $Y=Xa$ que agregue Ventas, Publicidad y
Satisfaccion_cliente mediante un vector de pesos $a$ justificados con
criterio empresarial, por ejemplo, un índice de rendimiento que priorice
Ventas, o un índice de intensidad de marketing que dé mayor peso a
Publicidad. Calcula por formulación matricial su vector de medias y
matriz de covarianzas muestra, interpreta lo obtenido en el contexto del
problema.

#### Respuesta

Consideremos el vector $a$, con los pesos siguientes: Ventas $(60 \%)$,
ya que representa el rendimiento tangible; Publicidad $(25 \%)$, es el
esfuerzo de marketing que impulsa las ventas y Satisfacción $(15 \%)$
que refleja sostenibilidad futura y reputación de manera que: $$
a=[0.6 \quad  0.25 \quad 0.15]^t
$$ Este vector de pesos suma 1 y asigna la prioridad al resultado
económico. Consideremos ahora la matriz $X$: $$
X = [Ventas \quad Publicidad \quad Satisfacion\_cliente]
$$ Entonces, la varible $Y=Xa$ será: $$
Y = Xa = 0.6 \cdot Ventas + 0.25 \cdot Publicidad + 0.15 \cdot Satisfacion\_cliente
$$ Veamos en R:

```{r, message=FALSE}
# extraemos las varibles que nos interesan del dataframe
X <- as.matrix(datos_empresa[, c("Ventas", "Publicidad", "Satisfaccion_cliente")])

# vector de pesos
a <- matrix(c(0.6, 0.25, 0.15), ncol = 1)

# Calculamos la varible compuesta
Y <- X %*% a

# calculamos el vector de medias
media_X <- colMeans(X)
media_X

# calculamos la matriz de covarianzas
S <- cov(X) #no hay que hacer el arreglo *(nrow(X) - 1)/nrow(X)
S

# Media y varianza de Y
media_Y <- t(a) %*% media_X
var_Y <- t(a) %*% S %*% a

# resultados
cat("Media de Y:", media_Y, "\n")
cat("Varianza de Y:", var_Y, "\n")
```

Según los pesos que hemos atribuido a las variables, podemos ver las
contribuciones de las medias a $\bar{Y}$ como suma ponderada de las
medias: $\bar{Y} = a'\bar{X}$, donde $a' = a$.

De esta manera las contribuciones quedan:

-   Ventas -\> $0.6 \cdot 164 = 98,40$ ---\>
    $(98,40 \cdot 100)/media(Y) \approx 91,33 \%$ de la media de Y

-   Publicidad -\> $0.25 \cdot 32,33... = 8,083333...$ -–\>
    $(8,08333... \cdot 100)/media(Y) \approx 7,50 \%$ de la media de Y

-   Satisfaccion_cliente -\> $0.15 \cdot 8,34666... = 1,25199...$ –-\>
    $(1,25199... \cdot 100)/media(Y) \approx 1,16 \%$ de la media de Y

Una interpretación que podemos hacer, es que la media de $Y$ está
practicamente determinada por las ventas, por una parte porque las
ventas tienen la media más alta y por otra porque le hemos dado un peso
mayor, es decir, una mayor prioridad.

De la expresión $Var(Y) = a^tSa$, podemos ver que es $Var(Y)$ es una
forma cuadrática con la matriz de covarianzas. Al ser el término mayor
de $a$ el que acompaña las Ventas, eso quiere decir que la varianza de
las ventas tiene más peso que la varianza y las covarianzas del resto de
variables.

Por lo tanto, el hecho de priorizar las ventas a la hora de definir el
vector de ponderación $a$ implica que las ventas también tienen más peso
a la hora de determinar la media y la varianza de $Y$.

*Respuesta Irene:*

```{r}
a_rend <- c(0.6, 0.1, 0.3)   Y <- X %*% a_rend mean_rend <- x_bar_t %*% a_rend mean_rend  var_rend  <- t(a_rend) %*% S %*% a_rend var_rend
```

*Interpretación:* El resultado indica que el nivel medio de este
rendimiento ponderado para un producto de los 15 es 104.14. La
desviación típica (aprox 17.93) muestra una disperdión moderada entre
productos (CV = 17/104.14 = 0.1721 que corresponde a un 17.21%). Dado
que Ventas domina el peso y las tres variables están muy
correlacionadas, el índice se moverá casi en paralelo a Ventas:
productos con altas ventas (y, en menor medida, alta satisfacción)
obtendrán puntuaciones altas, mientras que la publicidad influye poco en
el ranking. Si buscamos un índice comparable en unidades, conviene
tipificar las variables antes de ponderarlas.

### Apartado d

Usa el teorema de la dimensión para ofrecer una breve interpretación
sobre la redundancia y la dispersión de `datos_empresa`.

#### Respuesta

*Respuesta Irene:* Xc matriz nxp, n=15, p=3, rang(Xc) =r mide la
dimensión efectiva del subespacio donde viven los datos. El max rang es
min(n-1,p)=3.

En nuestros datos, aunque el rango algebraico es r=3 ,
las correlaciones entre Ventas, Publicidad y Satisfacción son
\~0.95–0.99; por tanto, la dimensión efectiva es ≈1 y existe una alta
redundancia práctica entre variables. En términos de negocio, la mayor
parte de la variación se explica por un único factor común
(desempeño/atractivo del producto); añadir Publicidad o Satisfacción
aporta poca información nueva sobre Ventas

### Apartado e

Para estos datos calcula la varianza total y la varianza generalizada y
explica qué mide cada una. Comenta cómo cambian si aumentan las
correlaciones entre las variables o si se reescala alguna variable.

#### Respuesta

*Respuesta Irene:*

**Varianza total tr(S)**: Mide la dispersión agregada sumando cuánto
varía cada variable por separado (no usa las correlaciones).

```{r}
traza_X <- sum(diag(S))
traza_X
```

La varianza total suma cuánto varía cada variable por separado. No
incorpora las correlaciones entre variables.

-   **Varianza generalizada**(det(S)):

Mide la dispersión conjunta de las variables: el “volumen” de la nube de
datos en el espacio multidimensional. Si hay colinealidad fuerte, este
volumen se hace pequeño; si alguna variable es combinación lineal exacta
de otras, entonces det(S)=0.

```{r}
var_total <-det(S)
var_total
```

Si aumentan las correlaciones (manteniendo fijas las varianzas), la
varianza total tr(S) no cambia porque solo depende de las varianzas
individuales, mientras que la varianza generalizada det(S) disminuye: el
“volumen” conjunto se aplana. Esto se ve en la descomposición det(S) =
(productori sigma_i\^2)\*det(R); al crecer las correlaciones, baja y, en
consecuencia, también lo hace det(S).

### Apartado f

Selecciona la medida de distancia más adecuada para identificar qué
observaciones multivariantes son similares y cuáles no.

#### Respuesta

*Respuesta Irene:*

Entre las distancias que hemos dado para variables cuantitativas, la de
Mahalanobis es la más adecuada para identificar qué observaciones
multivariantes son similares y cuáles no. Esto se debe a que, a
diferencia de la euclídea o la de Minkowski, la distancia de Mahalanobis
tiene en cuenta las correlaciones entre variables y las diferencias de
escala, es decir, ajusta el espacio de las observaciones según la
estructura de covarianzas del conjunto de datos. Así, dos observaciones
pueden parecer alejadas en términos euclídeos pero resultar próximas
cuando se considera que varían conjuntamente en la misma dirección que
las variables están correlacionadas.

En este contexto, donde las variables (Ventas, Publicidad y
Satisfacción) están fuertemente correlacionadas y en distintas unidades,
la distancia de Mahalanobis es la que mide de forma más realista la
similitud multivariante entre productos.

```{r}
d2 <- stats::mahalanobis(X, center = colMeans(X), cov = cov(X)) 
d  <- sqrt(d2)

D <- as.matrix(dist(d, method = "euclidean"))
labs <- paste0("P", seq_len(nrow(D)))
rownames(D) <- colnames(D) <- labs

df <- as_tibble(D, rownames = "From") |>
  pivot_longer(-From, names_to = "To", values_to = "delta_d")

ggplot(df, aes(From, To, fill = delta_d)) +
  geom_tile() +
  coord_equal() +
  labs(title = "Similitud por distancia a la media",
       x = "", y = "", fill = "|Δ d|") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```
